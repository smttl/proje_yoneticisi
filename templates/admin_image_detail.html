<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Puan Detayı: {{ image.id }}</title>
    <style>
        body { font-family: sans-serif; display: flex; height: 100vh; margin: 0; }
        
        #sidebar {
            width: 350px; min-width: 350px; background: #f9f9f9;
            border-left: 1px solid #ccc; overflow-y: auto; padding: 15px;
            flex-shrink: 0;
        }
        #main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f0f0f0;
        }
        
        /* Görüntü Önizleme */
        #image-preview {
            background: #333; padding: 10px; border-radius: 4px; text-align: center;
        }
        #image-preview img {
            max-width: 100%; max-height: 40vh; border: 1px solid #fff;
        }

        /* Bilgi Kutuları */
        .info-box {
            background: #fff; border: 1px solid #ddd; border-radius: 4px;
            margin-top: 20px; padding: 15px;
        }
        .info-box h3 { margin-top: 0; }
        .info-box ul { padding-left: 20px; margin: 0; }
        .info-box li { margin-bottom: 5px; }

        /* İndirme Butonları */
        .download-links a {
            display: inline-block;
            background: #007bff; color: white; text-decoration: none;
            padding: 8px 12px; border-radius: 4px; margin-right: 5px; margin-bottom: 5px;
        }
        .download-links a.labelme { background: #17a2b8; }
        
        /* Kırpılmış Oosit Kutuları */
        .detection-card {
            display: flex;
            gap: 15px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
        }
        .detection-crop {
            flex-shrink: 0;
            width: 200px;
            text-align: center;
        }
        .detection-crop img {
            max-width: 100%;
            border: 2px solid #000;
        }
        .detection-scores {
            flex-grow: 1;
        }
        .detection-scores h4 { margin-top: 0; }

        /* Puan Tablosu */
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        tr:nth-child(even) { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <aside id="sidebar">
        <h2>Görüntü Yönetimi</h2>
        <p><a href="{{ url_for('admin_dashboard') }}">&larr; Admin Paneline Dön</a></p>
        <p><strong>ID:</strong> {{ image.id }}</p>
        
        <div id="image-preview">
            <img src="{{ url_for('static', filename=image.preview_path) }}" alt="Oosit Önizleme">
        </div>

        <div class="info-box">
            <h3>Metadata</h3>
            <ul>
                <li><strong>Yükleyen:</strong> {{ image.uploader.username if image.uploader else 'Bilinmiyor' }}</li>
                <li><strong>Ölçek:</strong> {{ image.metadata_json.get('scale_um_per_pixel') | round(4) }} µm/pixel</li>
                <li><strong>Çekim Tarihi:</strong> {{ image.metadata_json.get('acquisition_date', 'N/A') }}</li>
                <li><strong>Objektif:</strong> {{ image.metadata_json.get('objective_name', 'N/A') }}</li>
                <li><strong>Kanallar:</strong> {{ image.metadata_json.get('channel_names', ['N/A']) | join(', ') }}</li>
            </ul>
        </div>
        
        <div class="info-box download-links">
            <h3>Dosyaları İndir</h3>
            <a href="{{ url_for('admin_download_czi', image_id=image.id) }}">Orijinal .CZI İndir</a>
            <a href="{{ url_for('admin_download_png', image_id=image.id) }}">Önizleme .PNG İndir</a>
            <a href="{{ url_for('admin_download_labelme_image', image_id=image.id) }}" class="labelme">Tüm Oositler (LabelMe .JSON)</a>
        </div>
    </aside>

    <main id="main-content">
        <h2>Oosit Puanlama Detayları (Toplam: {{ image.detections|length }})</h2>
        <p>Aşağıda bu görüntü için tespit edilen her oositin kırpılmış görüntüsü ve uzmanlar tarafından verilen puanlar listelenmiştir.</p>
        
        {% for detection in image.detections %}
        <div class="detection-card">
            <div class="detection-crop">
                <h4>Oosit: {{ detection.id.split('_')[-1] }}</h4>
                <img src="{{ url_for('admin_image_crop', detection_id=detection.id) }}" alt="Kırpılmış Oosit">
                <br><br>
                </div>
            
            <div class="detection-scores">
                <h4>Uzman Puanları</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Uzman</th>
                            <th>Sitoplazma</th>
                            <th>Zona</th>
                            <th>Kumulus</th>
                            <th>Oopla</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set scores_found = namespace(count=0) %}
                        {% for score in detection.scores %}
                            <tr>
                                <td><strong>{{ score.user.username }}</strong></td>
                                <td>{{ score.score_sitoplazma | default('N/A', true) }}</td>
                                <td>{{ score.score_zona | default('N/A', true) }}</td>
                                <td>{{ score.score_kumulus | default('N/A', true) }}</td>
                                <td>{{ score.score_oopla | default('N/A', true) }}</td>
                            </tr>
                            {% set scores_found.count = scores_found.count + 1 %}
                        {% endfor %}
                        
                        {% if scores_found.count == 0 %}
                        <tr><td colspan="5">Bu oosit henüz puanlanmamış.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div class="info-box">
            <h3>Tespit Bulunamadı</h3>
            <p>Bu görüntü için (YOLOv8 tarafından) tespit edilmiş oosit bulunamadı veya veritabanına kaydedilmedi.</p>
        </div>
        {% endfor %}
    </main>
</body>
</html>