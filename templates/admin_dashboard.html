<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Admin Paneli</title>
    <style>
        body { font-family: sans-serif; padding: 2rem; }
        nav { display: flex; justify-content: space-between; align-items: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        .flash { padding: 1rem; margin-bottom: 1rem; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .danger { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .container { display: flex; gap: 2rem; }
        .col-main { flex-grow: 1; }
        .col-side { width: 300px; flex-shrink: 0; }
        .assignment-form { margin-top: 10px; }
        .btn-download {
            display: inline-block; padding: 10px 15px; background: #28a745; 
            color: white; text-decoration: none; border-radius: 4px;
        }
        .btn-delete {
            background: #dc3545; color: white; border: none; 
            padding: 5px 10px; border-radius: 4px; cursor: pointer;
        }
        /* YENİ: Yan paneldeki kutu stilleri */
        .side-box {
            background: #fff; border: 1px solid #ddd;
            border-radius: 4px; padding: 15px; margin-top: 20px;
        }
        .side-box h2 { margin-top: 0; }
        .side-box input[type="text"], .side-box input[type="password"] {
            width: 90%; padding: 8px; margin-bottom: 10px;
        }
        .side-box button {
            width: 100%; padding: 10px; background: #007bff;
            color: white; border: none; border-radius: 4px; cursor: pointer;
        }
    </style>
</head>
<body>
    <nav>
        <h1>Admin Paneli</h1>
        <span>
            Hoş geldin, {{ current_user.username }} (Admin) | 
            <a href="{{ url_for('dashboard') }}">Uzman Paneline Git</a> | 
            <a href="{{ url_for('logout') }}">Çıkış Yap</a>
        </span>
    </nav>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="flash {{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="container">
        <div class="col-main">
            <h2>Tüm Görüntüler (Toplam: {{ images|length }})</h2>
            <table>
                <thead>
                    <tr>
                        <th>Görüntü ID</th>
                        <th>Yükleyen Uzman</th>
                        <th>Puanlama Detayı</th>
                        <th>Uzmana Ata</th>
                        <th>Yönet</th>
                    </tr>
                </thead>
                <tbody>
                    {% for image in images %}
                    <tr>
                        <td>{{ image.id }}</td>
                        <td>{{ image.uploader.username if image.uploader else 'Admin/Bilinmiyor' }}</td>
                        <td>
                            <a href="{{ url_for('admin_image_detail', image_id=image.id) }}">Puanları Gör</a>
                        </td>
                        <td>
                            <form class="assignment-form" method="POST" action="{{ url_for('admin_assign_image', image_id=image.id) }}">
                                <select name="expert_id" required>
                                    <option value="" disabled selected>Uzman Seç...</option>
                                    {% for expert in experts %}
                                    <option value="{{ expert.id }}">{{ expert.username }}</option>
                                    {% endfor %}
                                </select>
                                <button type="submit">Ata</button>
                            </form>
                        </td>
                        <td>
                            <form method="POST" action="{{ url_for('admin_delete_image', image_id=image.id) }}" 
                                  onsubmit="return confirm('Görüntüyü ve tüm verilerini kalıcı olarak silmek istediğinizden emin misiniz?');">
                                <button type="submit" class="btn-delete">Sil</button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="5">Sistemde hiç görüntü yok.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="col-side">
            <div class="side-box">
                <h2>Yeni Uzman Ekle</h2>
                <form method="POST" action="{{ url_for('admin_create_user') }}">
                    <div>
                        <label for="username">Kullanıcı Adı:</label>
                        <input type="text" id="username" name="username" required>
                    </div>
                    <div>
                        <label for="password">Şifre:</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    <button type="submit">Uzmanı Oluştur</button>
                </form>
            </div>

            <div class="side-box">
                <h2>İstatistikler</h2>
                <p>Toplam Uzman: {{ experts|length }}</p>
                <p>Toplam Görüntü: {{ images|length }}</p>
            </div>
            
            <div class="side-box">
                <h2>Tüm Puanları İndir</h2>
                <p>Tüm puanları Excel (.xlsx) dosyası olarak indirin.</p>
                <a href="{{ url_for('admin_download_scores') }}" class="btn-download">Excel Olarak İndir</a>
            </div>
        </div>
    </div>
</body>
</html>