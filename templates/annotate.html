<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Değerlendir: {{ image.id }}</title>
    <style>
        body { font-family: sans-serif; display: flex; height: 100vh; margin: 0; }
        #main-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        #top-bar { 
            padding: 10px; background: #f0f0f0; border-bottom: 1px solid #ccc; 
            flex-shrink: 0; /* Küçülmesin */
        }
        
        /* === YENİ (Zoom için) === */
        /* Bu ana konteyner kaydırma çubuklarını gösterecek */
        #image-viewer { 
            flex-grow: 1; 
            /* overflow: auto; -> JS ile kontrol edilecek */
            background: #333; 
            position: relative; 
            overflow: auto; /* Kaydırma çubukları eklendi */
        }
        
        /* Bu konteyner resim ve canvas'ı tutar ve zoom'lanır */
        #image-container { 
            position: relative; 
            width: fit-content; /* İçeriğe göre boyutlanır */
            margin: auto; /* Ortalamak için */
            /* transform-origin: top left; -> Alternatif zoom yöntemi, bu daha basit */
        }
        
        #oocyte-image { 
            display: block; 
            /* max-width: 100% kaldırıldı, JS ile kontrol edilecek */
        }
        #drawing-canvas { 
            position: absolute; 
            top: 0; 
            left: 0; 
            /* cursor: default; -> JS ile kontrol edilecek */
        }
        /* ======================== */
        
        #sidebar {
            width: 350px; min-width: 350px; background: #f9f9f9;
            border-left: 1px solid #ccc; overflow-y: auto; padding: 15px;
            flex-shrink: 0; /* Küçülmesin */
        }
        .tool-btn, .zoom-btn { 
            padding: 8px 12px; margin-right: 5px; cursor: pointer; 
            background: #ddd; border: 1px solid #aaa; border-radius: 4px;
        }
        .tool-btn.active { background: #007bff; color: white; }
        #scoring-panel .detection {
            margin-bottom: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;
        }
        /* ... (diğer stilleriniz aynı) ... */
    </style>
</head>
<body>

    <aside id="sidebar">
        <h2>Değerlendirme</h2>
        <p><strong>Görüntü:</strong> {{ image.id }}</p>
        <p><strong>Ölçek:</strong> {{ image.metadata_json.get('scale_um_per_pixel') | round(3) }} µm/pixel</p>
        <hr>
        <div id="scoring-panel">
            </div>
    </aside>

    <main id="main-content">
        <div id="top-bar">
            <a href="{{ url_for('dashboard') }}">&larr; Geri Dön</a> |
            <strong>Araçlar:</strong>
            <button id="tool-pan" class="tool-btn active">Gezin</button>
            <button id="tool-ruler" class="tool-btn">Cetvel</button>
            |
            <strong>Zoom:</strong>
            <button id="btn-zoom-in" class="zoom-btn">+</button>
            <button id="btn-zoom-out" class="zoom-btn">-</button>
            <button id="btn-zoom-reset" class="zoom-btn">Sıfırla</button>
            <span id="zoom-info" style="margin-left: 10px;">100%</span>
            
            <span id="ruler-info" style="margin-left: 20px; font-weight: bold; color: #00f;"></span>
        </div>
        
        <div id="image-viewer">
            <div id="image-container">
                <img id="oocyte-image" src="{{ url_for('static', filename=image.preview_path) }}" alt="Oosit Görüntüsü">
                <canvas id="drawing-canvas"></canvas>
            </div>
        </div>
    </main>

    <script>
        // --- Flask'tan Verileri Al ---
        const detections = {{ detections_json | safe }};
        const metadata = {{ metadata_json | safe }};
        const scaleUmPerPixel = metadata.scale_um_per_pixel;

        // --- Global Değişkenler ---
        let currentTool = 'pan'; // 'pan', 'ruler'
        let isDrawing = false;
        let rulerStart = {};
        let rulerEnd = {};
        let zoomLevel = 1.0; // YENİ: Zoom seviyesi (1.0 = %100)
        let isPanning = false; // YENİ: Gezinme (pan)
        let panStart = { x: 0, y: 0 }; // YENİ
        
        // --- Element Referansları ---
        const img = document.getElementById('oocyte-image');
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');
        const scoringPanel = document.getElementById('scoring-panel');
        const rulerInfo = document.getElementById('ruler-info');
        const zoomInfo = document.getElementById('zoom-info'); // YENİ
        const imageViewer = document.getElementById('image-viewer'); // YENİ

        
        // --- 1. Başlangıç (Setup) ---
        window.onload = () => {
            if (img.complete) {
                initializeCanvas();
            } else {
                img.onload = initializeCanvas;
            }
            setupTools();
            setupZoom(); // YENİ
            populateScoringPanel();
        };

        function initializeCanvas() {
            // YENİ: Görüntüyü "ekrana sığdır" (fit-to-screen) moduyla başlat
            const viewerWidth = imageViewer.clientWidth;
            // Orijinal en/boy oranını koru
            const initialScale = viewerWidth / img.naturalWidth;
            
            // Eğer görüntü zaten ekrandan küçükse, %100'de başlat
            if (initialScale >= 1.0) {
                applyZoom(1.0);
            } else {
                applyZoom(initialScale);
            }
        }
        
        // --- YENİ: Zoom Fonksiyonu ---
        function applyZoom(newLevel) {
            // Min %25, Max %500 zoom
            if (newLevel < 0.25) newLevel = 0.25;
            if (newLevel > 5.0) newLevel = 5.0;
            
            zoomLevel = newLevel;

            // Görüntünün ve canvas'ın YENİ boyutlarını hesapla
            const newWidth = img.naturalWidth * zoomLevel;
            const newHeight = img.naturalHeight * zoomLevel;

            // 1. Style (Görünür) boyutlarını ayarla
            img.style.width = newWidth + 'px';
            img.style.height = newHeight + 'px';
            canvas.style.width = newWidth + 'px';
            canvas.style.height = newHeight + 'px';
            
            // 2. Canvas'ın Çizim Yüzeyi boyutunu ayarla (Burası kritik)
            // Bu, çizimlerin zoom yaptıkça keskin kalmasını sağlar
            canvas.width = newWidth;
            canvas.height = newHeight;
            
            // Her şeyi yeni boyuta göre yeniden çiz
            drawAll();
            
            // Arayüzü güncelle
            zoomInfo.textContent = `${Math.round(zoomLevel * 100)}%`;
        }

        // --- 2. Çizim Fonksiyonları ---
        function drawAll() {
            // Canvas boyutu artık 'applyZoom'da ayarlandığı için
            // burada 'clientWidth' vb. okumaya gerek yok.
            
            // Orijinal resim boyutu ile ŞU ANKİ canvas boyutu arasındaki oranı bul
            // Bu bizim zoom seviyemizdir.
            const scaleX = canvas.width / img.naturalWidth;
            const scaleY = canvas.height / img.naturalHeight;

            // Önceki çizimleri temizle
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // A. Oosit Tespitlerini (Kutular) Çiz
            detections.forEach(detection => {
                const coords = detection.coordinates_labelme.points;
                
                // Orijinal koordinatları al, zoom seviyesiyle çarp
                const x1 = coords[0][0] * scaleX;
                const y1 = coords[0][1] * scaleY;
                const x2 = coords[1][0] * scaleX;
                const y2 = coords[1][1] * scaleY;

                const width = x2 - x1;
                const height = y2 - y1;

                ctx.strokeStyle = 'red';
                ctx.lineWidth = 2 * zoomLevel; // Çizgi kalınlığı da zoom'lansın
                ctx.strokeRect(x1, y1, width, height);
                
                ctx.font = `${16 * zoomLevel}px Arial`; // Font boyutu da zoom'lansın
                ctx.fillStyle = 'red';
                ctx.fillText(detection.id.split('_').pop(), x1, y1 > 10 ? y1 - 5 : y1 + 15 * zoomLevel);
            });

            // B. Cetvel Çizimini Yap
            if (currentTool === 'ruler' && (isDrawing || rulerEnd.x)) {
                ctx.strokeStyle = '#00f';
                ctx.lineWidth = 2 * zoomLevel; // Cetvel kalınlığı
                ctx.beginPath();
                ctx.moveTo(rulerStart.x, rulerStart.y);
                ctx.lineTo(rulerEnd.x, rulerEnd.y);
                ctx.stroke();

                // Uzunluğu Hesapla ve Yaz (HESAPLAMA GÜNCELLENDİ)
                const { pixelDist, umDist } = calculateDistance(rulerStart, rulerEnd);
                const text = `${umDist.toFixed(2)} µm`;
                rulerInfo.textContent = text;
                
                ctx.fillStyle = '#00f';
                ctx.font = `${14 * zoomLevel}px Arial`;
                ctx.fillText(text, rulerEnd.x + 5, rulerEnd.y - 5);
            }
        }
        
        // --- GÜNCELLENDİ (calculateDistance) ---
        function calculateDistance(start, end) {
            // 1. Ekranda (canvas üzerinde) çizilen piksel mesafesi
            const canvasPixelDx = end.x - start.x;
            const canvasPixelDy = end.y - start.y;
            const canvasPixelDist = Math.sqrt(canvasPixelDx**2 + canvasPixelDy**2);
            
            // 2. Bunu ORİJİNAL resim piksellerine çevir (Zoom'u geri al)
            // (canvas.width / img.naturalWidth) -> zoomLevel
            const originalPixelDist = canvasPixelDist / zoomLevel; 
            
            // 3. Orijinal pikselleri mikrometreye çevir
            const umDist = originalPixelDist * scaleUmPerPixel;
            
            return { pixelDist: originalPixelDist, umDist: umDist };
        }

        // --- 3. Araçlar ve Olay Yöneticileri (Event Handlers) ---
        
        // YENİ: Zoom Düğmeleri
        function setupZoom() {
            document.getElementById('btn-zoom-in').onclick = () => applyZoom(zoomLevel + 0.25);
            document.getElementById('btn-zoom-out').onclick = () => applyZoom(zoomLevel - 0.25);
            document.getElementById('btn-zoom-reset').onclick = () => initializeCanvas(); // Ekrana sığdıra döner
        }
        
        // GÜNCELLENDİ (setupTools)
        function setupTools() {
            document.getElementById('tool-pan').onclick = () => setTool('pan');
            document.getElementById('tool-ruler').onclick = () => setTool('ruler');

            canvas.onmousedown = (e) => {
                if (currentTool === 'ruler') {
                    isDrawing = true;
                    // e.offsetX koordinatları canvas'a göre (0, 3000) aralığında gelir
                    // Bu, zoom'lanmış koordinat sisteminde tam istediğimiz şey.
                    rulerStart = { x: e.offsetX, y: e.offsetY };
                    rulerEnd = { x: e.offsetX, y: e.offsetY };
                } else if (currentTool === 'pan') {
                    isPanning = true;
                    panStart.x = e.clientX;
                    panStart.y = e.clientY;
                    canvas.style.cursor = 'grabbing';
                }
                drawAll();
            };

            canvas.onmousemove = (e) => {
                if (currentTool === 'ruler' && isDrawing) {
                    rulerEnd = { x: e.offsetX, y: e.offsetY };
                } else if (currentTool === 'pan' && isPanning) {
                    const dx = e.clientX - panStart.x;
                    const dy = e.clientY - panStart.y;
                    
                    // Kaydırma çubuklarını hareket ettir
                    imageViewer.scrollLeft -= dx;
                    imageViewer.scrollTop -= dy;
                    
                    // Başlangıç noktasını güncelle
                    panStart.x = e.clientX;
                    panStart.y = e.clientY;
                }
                drawAll();
            };

            canvas.onmouseup = (e) => {
                if (currentTool === 'ruler' && isDrawing) {
                    isDrawing = false;
                    rulerEnd = { x: e.offsetX, y: e.offsetY };
                } else if (currentTool === 'pan' && isPanning) {
                    isPanning = false;
                    canvas.style.cursor = 'grab';
                }
                drawAll();
            };
            
            canvas.onmouseleave = () => {
                isDrawing = false;
                isPanning = false;
                if (currentTool === 'pan') canvas.style.cursor = 'grab';
            };
        }
        
        // GÜNCELLENDİ (setTool)
        function setTool(tool) {
            currentTool = tool;
            document.getElementById('tool-pan').classList.toggle('active', tool === 'pan');
            document.getElementById('tool-ruler').classList.toggle('active', tool === 'ruler');
            
            if (tool === 'pan') {
                canvas.style.cursor = 'grab';
                rulerInfo.textContent = ''; // Cetvel bilgisini temizle
            } else {
                canvas.style.cursor = 'crosshair';
            }
            rulerStart = {}; // Cetveli sıfırla
            rulerEnd = {};
            drawAll();
        }

        // --- 4. Puanlama Paneli ve Kaydetme (DEĞİŞİKLİK YOK) ---
        function populateScoringPanel() {
            scoringPanel.innerHTML = ''; // Paneli temizle
            detections.forEach(det => {
                const scoreForm = document.createElement('div');
                scoreForm.className = 'detection';
                scoreForm.id = `score-form-${det.id}`;
                
                const scores = det.scores;
                
                scoreForm.innerHTML = `
                    <h3>Oosit: ${det.id.split('_').pop()} <span id="status-${det.id}" class="status-light ${Object.values(scores).some(s => s) ? 'saved' : ''}"></span></h3>
                    <div class="form-group">
                        <label>Sitoplazma Homojenitesi</label>
                        <input type="number" min="1" max="5" name="sitoplazma" value="${scores.sitoplazma || ''}">
                    </div>
                    <div class="form-group">
                        <label>Zona Pellucida Yapısı</label>
                        <input type="number" min="1" max="5" name="zona" value="${scores.zona || ''}">
                    </div>
                    <div class="form-group">
                        <label>Kumulus Bütünlüğü</label>
                        <input type="number" min="1" max="5" name="kumulus" value="${scores.kumulus || ''}">
                    </div>
                    <div class="form-group">
                        <label>Ooplazmik İçerik</label>
                        <input type="number" min="1" max="5" name="oopla" value="${scores.oopla || ''}">
                    </div>
                `;
                
                scoringPanel.appendChild(scoreForm);
                
                scoreForm.querySelectorAll('input').forEach(input => {
                    input.onchange = () => saveScores(det.id);
                });
            });
        }
        
        async function saveScores(detectionId) {
            const form = document.getElementById(`score-form-${detectionId}`);
            const statusLight = document.getElementById(`status-${detectionId}`);
            
            const scores = {
                sitoplazma: form.querySelector('input[name="sitoplazma"]').valueAsNumber || null,
                zona: form.querySelector('input[name="zona"]').valueAsNumber || null,
                kumulus: form.querySelector('input[name="kumulus"]').valueAsNumber || null,
                oopla: form.querySelector('input[name="oopla"]').valueAsNumber || null,
            };
            
            try {
                const response = await fetch('/api/save_score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ detection_id: detectionId, scores: scores })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusLight.classList.add('saved');
                } else {
                    alert('Hata: ' + result.error);
                }
            } catch (error) {
                alert('Puanlar kaydedilemedi. Sunucu hatası.');
            }
        }
    </script>
</body>
</html>