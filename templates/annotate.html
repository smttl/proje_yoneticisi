<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Değerlendir: {{ image.id }}</title>
    <style>
        body { font-family: sans-serif; display: flex; height: 100vh; margin: 0; }
        #main-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        #top-bar { 
            padding: 10px; background: #f0f0f0; border-bottom: 1px solid #ccc; 
            flex-shrink: 0;
        }
        #image-viewer { 
            flex-grow: 1; background: #333; 
            position: relative; overflow: auto;
        }
        #image-container { 
            position: relative; width: fit-content; margin: auto; 
        }
        #oocyte-image { display: block; }
        #drawing-canvas { position: absolute; top: 0; left: 0; }
        #sidebar {
            width: 350px; min-width: 350px; background: #f9f9f9;
            border-left: 1px solid #ccc; overflow-y: auto; padding: 15px;
            flex-shrink: 0;
        }
        
        .tool-btn, .zoom-btn { 
            padding: 8px 12px; margin-right: 5px; cursor: pointer; 
            background: #ddd; border: 1px solid #aaa; border-radius: 4px;
        }
        .tool-btn.active { background: #007bff; color: white; }
        #tool-add { background: #28a745; color: white; }
        #tool-add.active { background: #208037; }
        #tool-delete { background: #dc3545; color: white; }
        #tool-delete.active { background: #b02a37; }
        
        #scoring-panel .detection {
            margin-bottom: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;
        }
        #scoring-panel .detection h3 { margin-top: 0; }
        #scoring-panel .form-group { margin-bottom: 10px; }
        #scoring-panel .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        
        /* Puan Buton Grubu */
        .score-buttons {
            display: flex;
            justify-content: space-between;
        }
        .score-btn {
            flex-grow: 1;
            padding: 8px 5px;
            margin: 0 2px;
            cursor: pointer;
            border: 1px solid #aaa;
            background: #eee;
            border-radius: 4px;
            font-weight: bold;
        }
        .score-btn:hover { background: #ddd; }
        .score-btn.active {
            background: #28a745;
            color: white;
            border-color: #208037;
        }
        /* YENİ: A/B/C/D Butonları için özel stil */
        .score-btn.grade-btn {
            font-size: 1.1em;
        }
        .score-btn.grade-btn.active {
            background: #007bff; /* A/B/C/D seçilince mavi olsun */
            border-color: #0056b3;
        }
        
        .status-light { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #ccc; margin-left: 5px; }
        .status-light.saved { background: #28a745; }
    </style>
</head>
<body>

    <aside id="sidebar">
        <h2>Değerlendirme</h2>
        <p><strong>Görüntü:</strong> {{ image.id }}</p>
        <p><strong>Ölçek:</strong> {{ image.metadata_json.get('scale_um_per_pixel') | round(3) }} µm/pixel</p>
        <hr>
        <div id="scoring-panel">
            </div>
    </aside>

    <main id="main-content">
        <div id="top-bar">
            <a href="{{ url_for('dashboard') }}">&larr; Geri Dön</a> |
            <strong>Araçlar:</strong>
            <button id="tool-pan" class="tool-btn active">Gezin</button>
            <button id="tool-ruler" class="tool-btn">Cetvel</button>
            <button id="tool-add" class="tool-btn">Oosit Ekle</button>
            <button id="tool-delete" class="tool-btn">Tespit Sil</button>
            |
            <strong>Zoom:</strong>
            <button id="btn-zoom-in" class="zoom-btn">+</button>
            <button id="btn-zoom-out" class="zoom-btn">-</button>
            <button id="btn-zoom-reset" class="zoom-btn">Sıfırla</button>
            <span id="zoom-info" style="margin-left: 10px;">100%</span>
            
            <span id="ruler-info" style="margin-left: 20px; font-weight: bold; color: #00f;"></span>
        </div>
        
        <div id="image-viewer">
            <div id="image-container">
                <img id="oocyte-image" src="{{ url_for('static', filename=image.preview_path) }}" alt="Oosit Görüntüsü">
                <canvas id="drawing-canvas"></canvas>
            </div>
        </div>
    </main>

    <script>
        // --- Flask'tan Verileri Al ---
        const imageId = "{{ image.id }}";
        let detections = {{ detections_json | safe }}; 
        const metadata = {{ metadata_json | safe }};
        const scaleUmPerPixel = metadata.scale_um_per_pixel;

        // ... (Global Değişkenler ve Element Referansları aynı) ...
        let currentTool = 'pan';
        let isDrawing = false;
        let drawStart = {}; 
        let drawEnd = {};   
        let zoomLevel = 1.0; 
        let isPanning = false; 
        let panStart = { x: 0, y: 0 }; 
        const img = document.getElementById('oocyte-image');
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');
        const scoringPanel = document.getElementById('scoring-panel');
        const rulerInfo = document.getElementById('ruler-info');
        const zoomInfo = document.getElementById('zoom-info'); 
        const imageViewer = document.getElementById('image-viewer'); 

        
        // --- 1. Başlangıç (Setup) ---
        window.onload = () => {
            if (img.complete) initializeCanvas();
            else img.onload = initializeCanvas;
            setupTools();
            setupZoom(); 
            populateScoringPanel();
        };

        function initializeCanvas() {
            const viewerWidth = imageViewer.clientWidth;
            const initialScale = viewerWidth / img.naturalWidth;
            applyZoom(initialScale >= 1.0 ? 1.0 : initialScale);
        }
        
        // ... (applyZoom fonksiyonu aynı) ...
        function applyZoom(newLevel) {
            zoomLevel = Math.max(0.25, Math.min(newLevel, 5.0));
            const newWidth = img.naturalWidth * zoomLevel;
            const newHeight = img.naturalHeight * zoomLevel;
            img.style.width = newWidth + 'px';
            img.style.height = newHeight + 'px';
            canvas.style.width = newWidth + 'px';
            canvas.style.height = newHeight + 'px';
            canvas.width = newWidth;
            canvas.height = newHeight;
            drawAll();
            zoomInfo.textContent = `${Math.round(zoomLevel * 100)}%`;
        }

        // --- 2. Çizim Fonksiyonları ---
        // ... (drawAll fonksiyonu aynı) ...
        function drawAll() {
            const scaleX = canvas.width / img.naturalWidth;
            const scaleY = canvas.height / img.naturalHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // A. Mevcut Oosit Tespitlerini Çiz
            detections.forEach(detection => {
                const coords = detection.coordinates_labelme.points;
                const x1 = coords[0][0] * scaleX;
                const y1 = coords[0][1] * scaleY;
                const x2 = coords[1][0] * scaleX;
                const y2 = coords[1][1] * scaleY;
                const width = x2 - x1;
                const height = y2 - y1;
                ctx.strokeStyle = 'red';
                ctx.lineWidth = 2 * zoomLevel; 
                ctx.strokeRect(x1, y1, width, height);
                ctx.font = `${16 * zoomLevel}px Arial`; 
                ctx.fillStyle = 'red';
                ctx.fillText(detection.id.split('_').pop(), x1, y1 > 10 ? y1 - 5 : y1 + 15 * zoomLevel);
            });
            // B. Cetvel Çizimini Yap
            if (currentTool === 'ruler' && (isDrawing || drawEnd.x)) {
                ctx.strokeStyle = '#00f';
                ctx.lineWidth = 2 * zoomLevel; 
                ctx.beginPath();
                ctx.moveTo(drawStart.x, drawStart.y);
                ctx.lineTo(drawEnd.x, drawEnd.y);
                ctx.stroke();
                const { umDist } = calculateDistance(drawStart, drawEnd);
                const text = `${umDist.toFixed(2)} µm`;
                rulerInfo.textContent = text;
                ctx.fillStyle = '#00f';
                ctx.font = `${14 * zoomLevel}px Arial`;
                ctx.fillText(text, drawEnd.x + 5, drawEnd.y - 5);
            }
            // C. Oosit Ekleme Kutusunu Çiz
            if (currentTool === 'add' && isDrawing) {
                ctx.strokeStyle = '#28a745';
                ctx.lineWidth = 2 * zoomLevel; 
                ctx.setLineDash([5, 5]);
                const width = drawEnd.x - drawStart.x;
                const height = drawEnd.y - drawStart.y;
                ctx.strokeRect(drawStart.x, drawStart.y, width, height);
                ctx.setLineDash([]);
            }
        }
        // ... (calculateDistance fonksiyonu aynı) ...
        function calculateDistance(start, end) {
            const canvasPixelDist = Math.sqrt((end.x - start.x)**2 + (end.y - start.y)**2);
            const originalPixelDist = canvasPixelDist / zoomLevel; 
            const umDist = originalPixelDist * scaleUmPerPixel;
            return { pixelDist: originalPixelDist, umDist: umDist };
        }

        // --- 3. Araçlar ve Olay Yöneticileri ---
        // ... (setupZoom fonksiyonu aynı) ...
        function setupZoom() {
            document.getElementById('btn-zoom-in').onclick = () => applyZoom(zoomLevel + 0.25);
            document.getElementById('btn-zoom-out').onclick = () => applyZoom(zoomLevel - 0.25);
            document.getElementById('btn-zoom-reset').onclick = () => initializeCanvas(); 
        }
        // ... (setupTools fonksiyonu (onmousedown, onmousemove, onmouseup) aynı) ...
        function setupTools() {
            document.getElementById('tool-pan').onclick = () => setTool('pan');
            document.getElementById('tool-ruler').onclick = () => setTool('ruler');
            document.getElementById('tool-add').onclick = () => setTool('add');
            document.getElementById('tool-delete').onclick = () => setTool('delete');

            canvas.onmousedown = (e) => {
                if (currentTool === 'ruler' || currentTool === 'add') {
                    isDrawing = true;
                    drawStart = { x: e.offsetX, y: e.offsetY };
                    drawEnd = { x: e.offsetX, y: e.offsetY };
                } else if (currentTool === 'pan') {
                    isPanning = true;
                    panStart.x = e.clientX;
                    panStart.y = e.clientY;
                    canvas.style.cursor = 'grabbing';
                }
                drawAll();
            };
            canvas.onmousemove = (e) => {
                if ((currentTool === 'ruler' || currentTool === 'add') && isDrawing) {
                    drawEnd = { x: e.offsetX, y: e.offsetY };
                } else if (currentTool === 'pan' && isPanning) {
                    const dx = e.clientX - panStart.x;
                    const dy = e.clientY - panStart.y;
                    imageViewer.scrollLeft -= dx;
                    imageViewer.scrollTop -= dy;
                    panStart.x = e.clientX;
                    panStart.y = e.clientY;
                }
                drawAll();
            };
            canvas.onmouseup = (e) => {
                if (isDrawing) {
                    isDrawing = false;
                    drawEnd = { x: e.offsetX, y: e.offsetY };
                    if (currentTool === 'add') {
                        const canvasX1 = Math.min(drawStart.x, drawEnd.x);
                        const canvasY1 = Math.min(drawStart.y, drawEnd.y);
                        const canvasX2 = Math.max(drawStart.x, drawEnd.x);
                        const canvasY2 = Math.max(drawStart.y, drawEnd.y);
                        const originalCoords = [
                            [canvasX1 / zoomLevel, canvasY1 / zoomLevel],
                            [canvasX2 / zoomLevel, canvasY2 / zoomLevel]
                        ];
                        saveNewDetection(originalCoords);
                        setTool('pan'); 
                    }
                } 
                else if (isPanning) {
                    isPanning = false;
                    if (currentTool === 'pan') canvas.style.cursor = 'grab';
                }
                else if (currentTool === 'delete' && !isPanning && !isDrawing) {
                    const clickPos = { x: e.offsetX, y: e.offsetY };
                    const detectionToClick = findClickedDetection(clickPos);
                    if (detectionToClick) {
                        if (confirm(`'${detectionToClick.id}' ID'li oositi silmek istediğinizden emin misiniz?`)) {
                            deleteDetectionOnServer(detectionToClick.id);
                        }
                    }
                }
                drawAll();
            };
            canvas.onmouseleave = () => {
                isDrawing = false;
                isPanning = false;
                if (currentTool === 'pan') canvas.style.cursor = 'grab';
            };
        }
        // ... (setTool fonksiyonu aynı) ...
        function setTool(tool) {
            currentTool = tool;
            document.getElementById('tool-pan').classList.toggle('active', tool === 'pan');
            document.getElementById('tool-ruler').classList.toggle('active', tool === 'ruler');
            document.getElementById('tool-add').classList.toggle('active', tool === 'add');
            document.getElementById('tool-delete').classList.toggle('active', tool === 'delete');
            if (tool === 'pan') { canvas.style.cursor = 'grab'; rulerInfo.textContent = ''; }
            else if (tool === 'ruler' || tool === 'add') { canvas.style.cursor = 'crosshair'; }
            else if (tool === 'delete') { canvas.style.cursor = 'not-allowed'; }
            drawStart = {}; drawEnd = {};
            drawAll();
        }

        // --- 4. Puanlama Paneli ve Kaydetme (GÜNCELLENDİ) ---
        
        // ... (findClickedDetection, deleteDetectionOnServer, saveNewDetection aynı) ...
        function findClickedDetection(clickPos) {
            const scaleX = canvas.width / img.naturalWidth;
            const scaleY = canvas.height / img.naturalHeight;
            for (let i = detections.length - 1; i >= 0; i--) {
                const det = detections[i];
                const coords = det.coordinates_labelme.points;
                const x1 = coords[0][0] * scaleX, y1 = coords[0][1] * scaleY;
                const x2 = coords[1][0] * scaleX, y2 = coords[1][1] * scaleY;
                if (clickPos.x >= x1 && clickPos.x <= x2 && clickPos.y >= y1 && clickPos.y <= y2) {
                    return det;
                }
            }
            return null;
        }
        async function deleteDetectionOnServer(detectionId) {
            try {
                const response = await fetch('/api/delete_detection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ detection_id: detectionId })
                });
                const result = await response.json();
                if (result.success && result.deleted_id) {
                    detections = detections.filter(d => d.id !== result.deleted_id);
                    populateScoringPanel();
                    drawAll();
                } else { alert('Hata: Tespit silinemedi. ' + result.error); }
            } catch (error) { alert('Tespit silinirken sunucuya bağlanılamadı.'); }
        }
        async function saveNewDetection(originalCoords) {
            try {
                const response = await fetch('/api/add_detection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image_id: imageId, coordinates: originalCoords })
                });
                const result = await response.json();
                if (result.success && result.new_detection) {
                    detections.push(result.new_detection);
                    populateScoringPanel();
                    drawAll();
                } else { alert('Hata: Oosit eklenemedi. ' + result.error); }
            } catch (error) { alert('Oosit eklenirken sunucuya bağlanılamadı.'); }
        }
        
        // GÜNCELLENDİ: A/B/C/D Butonlarını Ekler
        function populateScoringPanel() {
            scoringPanel.innerHTML = '';
            detections.sort((a, b) => {
                const numA = parseInt(a.id.split('_').pop());
                const numB = parseInt(b.id.split('_').pop());
                return numA - numB;
            });
            
            detections.forEach(det => {
                const scoreForm = document.createElement('div');
                scoreForm.className = 'detection';
                scoreForm.id = `score-form-${det.id}`;
                
                const scores = det.scores;
                const isSaved = (scores.grade || Object.values(scores).some(s => s !== null));
                
                let formHTML = `<h3>Oosit: ${det.id.split('_').pop()} <span id="status-${det.id}" class="status-light ${isSaved ? 'saved' : ''}"></span></h3>`;
                
                // === YENİ: Genel Kalite (A, B, C, D) Butonları ===
                formHTML += `
                    <div class="form-group">
                        <label>Genel Kalite</label>
                        <div class="score-buttons" data-criterion="grade">
                `;
                const grades = ['A', 'B', 'C', 'D'];
                grades.forEach(g => {
                    const isActive = (scores.grade === g) ? 'active' : '';
                    formHTML += `
                        <button class="score-btn grade-btn ${isActive}" data-value="${g}" 
                                onclick="handleScoreClick(event, '${det.id}')">
                            ${g}
                        </button>
                    `;
                });
                formHTML += `</div></div><hr>`;
                // ===============================================

                // Puanlama kriterleri
                const criteria = [
                    { name: 'Sitoplazma', key: 'sitoplazma' },
                    { name: 'Zona', key: 'zona' },
                    { name: 'Kumulus', key: 'kumulus' },
                    { name: 'Ooplazma', key: 'oopla' }
                ];
                
                criteria.forEach(crit => {
                    formHTML += `
                        <div class="form-group">
                            <label>${crit.name}</label>
                            <div class="score-buttons" data-criterion="${crit.key}">
                    `;
                    for (let i = 1; i <= 5; i++) {
                        const isActive = (scores[crit.key] === i) ? 'active' : '';
                        formHTML += `
                            <button class="score-btn ${isActive}" data-value="${i}" 
                                    onclick="handleScoreClick(event, '${det.id}')">
                                ${i}
                            </button>
                        `;
                    }
                    formHTML += `</div></div>`;
                });
                
                scoreForm.innerHTML = formHTML;
                scoringPanel.appendChild(scoreForm);
            });
        }
        
        // GÜNCELLENDİ: Tıklanan butonu ayarlar ve kaydeder
        function handleScoreClick(event, detectionId) {
            event.preventDefault(); 
            const clickedButton = event.target;
            
            // 1. Arayüzü anında güncelle
            const buttonGroup = clickedButton.parentElement;
            buttonGroup.querySelectorAll('.score-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            clickedButton.classList.add('active');
            
            // 2. Skoru sunucuya kaydet
            saveScores(detectionId);
        }

        // GÜNCELLENDİ: Puanları (A/B/C/D DAHİL) okur ve kaydeder
        async function saveScores(detectionId) {
            const form = document.getElementById(`score-form-${detectionId}`);
            const statusLight = document.getElementById(`status-${detectionId}`);
            
            // 1. Genel Kalite (Grade) Puanını Oku
            const activeGradeButton = form.querySelector(`.score-buttons[data-criterion="grade"] .score-btn.active`);
            const grade = activeGradeButton ? activeGradeButton.dataset.value : null;

            // 2. 1-5 Arası Puanları Oku
            const scores = {};
            const criteria = ['sitoplazma', 'zona', 'kumulus', 'oopla'];
            criteria.forEach(critKey => {
                const activeButton = form.querySelector(`.score-buttons[data-criterion="${critKey}"] .score-btn.active`);
                scores[critKey] = activeButton ? Number(activeButton.dataset.value) : null;
            });
            
            try {
                const response = await fetch('/api/save_score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        detection_id: detectionId, 
                        grade: grade, // YENİ
                        scores: scores 
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusLight.classList.add('saved');
                } else {
                    alert('Hata: ' + result.error);
                }
            } catch (error) {
                alert('Puanlar kaydedilemedi. Sunucu hatası.');
            }
        }
    </script>
</body>
</html>